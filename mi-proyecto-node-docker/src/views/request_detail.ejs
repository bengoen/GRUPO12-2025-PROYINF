<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solicitud #<%= id %></title>
  <%- include('partials/head') %>
  <style>
    .wrap { max-width: 960px; margin: 24px auto; padding: 0 16px; }
    .card { border:1px solid #ddd; border-radius:10px; padding:14px; margin:12px 0; }
  </style>
</head>
<body>
  <%- include('partials/header') %>

<main class="wrap" id="req-root" data-id="<%= id %>">
  <a href="/requests" class="btn btn-link p-0" style="text-decoration:none;">&larr; Volver</a>
  <h1 class="mt-2 mb-2">Solicitud #<%= id %></h1>

  <div id="status" class="card">Cargando estado...</div>
</main>


  <%- include('partials/footer') %>

  <script>
    (function () {
      const id = Number(document.getElementById('req-root')?.dataset?.id);

      function humanStatus(code) {
        switch (code) {
          case 'PENDING_EVAL': return 'Pendiente de evaluación';
          case 'APPROVED': return 'Aprobado';
          case 'REJECTED': return 'Rechazado';
          case 'CONTRACT_PENDING': return 'Falta firmar contrato';
          case 'CONTRACT_SIGNED': return 'Contrato firmado';
          case 'ACTIVE': return 'Activo';
          case 'DISBURSED': return 'Desembolsado';
          default: return code || '';
        }
      }

      async function loadSummary() {
        try {
          const [statusRes, loanRes] = await Promise.all([
            fetch(`/api/loan-requests/${id}/status`),
            fetch(`/api/loan-requests/${id}/installments`)
          ]);
          if (!statusRes.ok) throw new Error('HTTP ' + statusRes.status);
          const s = await statusRes.json();

          let loan = null;
          if (loanRes.ok) {
            const data = await loanRes.json();
            loan = data && data.loan ? data.loan : null;
          }

          const updated = s.updated_at ? new Date(s.updated_at).toLocaleString() : '―';
          const actions = Array.isArray(s.next_actions) && s.next_actions.length
            ? (' · Próximas acciones: ' + s.next_actions.join(', '))
            : '';

          const amountText = loan && loan.amount != null ? `Monto: <b>${loan.amount}</b> · ` : '';
          const termText = loan && loan.term_months != null ? `Plazo: <b>${loan.term_months}</b> meses · ` : '';
          const cuotaText = loan && loan.monthly_payment != null ? `Cuota estimada: <b>${loan.monthly_payment}</b>` : '';

          document.getElementById('status').innerHTML =
            `<div><b>Estado:</b> ${humanStatus(s.status)} <small>(actualizado: ${updated})</small>${actions}</div>
             <div style="margin-top:8px;">${amountText}${termText}${cuotaText}</div>
             <div style="margin-top:8px;">
               <button class="btn btn-primary btn-sm me-2" onclick="goToContract(${id})">Revisar y firmar contrato</button>
               <button class="btn btn-secondary btn-sm" onclick="goToActiveLoans()">Ver préstamos activos</button>
             </div>`;
        } catch (err) {
          console.error(err);
          document.getElementById('status').innerHTML =
            `<span style="color:#b00020;">No se pudo cargar la información de la solicitud.</span>`;
        }
      }

      loadSummary();

      window.goToContract = function (loanId) {
        if (!Number.isFinite(loanId)) return;
        window.location.href = `/requests/${loanId}/contract`;
      };

      window.goToActiveLoans = function () {
        let aid = null;
        try { aid = localStorage.getItem('applicantId') || null; } catch (_) {}
        if (aid) {
          window.location.href = `/my-loans?applicantId=${encodeURIComponent(aid)}`;
        } else {
          window.location.href = '/my-loans';
        }
      };
    })();
  </script>
</body>
</html>

